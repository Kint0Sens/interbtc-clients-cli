# Premium BOT
## by Kint0Sens

### part of the TRADING/ARBITRAGE BOTS bounty (https://github.com/interlay/bounties/issues/2)

### License
Copyright 2022 Kint@Sens

The Premium BOT repository is a fork of the interlay/interbtc-clients. All the modifications are licensed under the Apache License, Version 2.0. 
See the LICENSE_PREMIUM_BOT file.

### Project Repository

### Video presentation
## Overview
The Premium BOT is composed of two binaries, the Redemer and the Issuer. They are supposed to be run in parallel. The Redeemer consumes KBTC[^1] when premium redeems are possible on some vaults and generates BTC. The Issuer consumes BTC and refills the Redeemer KBTC balance.

The Premium BOT is written in Rust as an fork of the interbtc-clients repository of interlay. 


<p align="center">
  <a href="/img/premium_bot.png">
    <img alt="Premium BOT flowchart" src="media/premium_bot.png">
  </a>


### The Redeemer
The purpose of the Redeemer is to monitor vaults for Premium Redeem opportunities and then request premium redeems with as much of its kBTC balance as possible and transfer BTC in the Issuer's BTC Wallet.

The Redeemer will monitor the active vaults until it finds a vault that offers Premium Redeem due to its collateralization level.
Once found it will request a premium redeem of the maximum available amount (limited by the bot's own kBTC balance).
Once the Redeemer has run out of kBTC balance it will stay idle until its balance is refilled and then it will resume searching for Premium Redeem Vaults.
<p align="center">
  <a href="/img/premium_bot.png">
    <img alt="Premium BOT flowchart" src="media/redeemer.png">
  </a>

### The Issuer
Tue purpose of the Issuer is to select a vault with issuable capacity and send issue request to it in order to consume BTC and fill the kBTC account of the Redeemer. The Issuer will repeat this as long as it has BTC Balance and as long as it finds a vault with some kBTC capacity. It will then be idle until its BTC balance is refilled again by the Redeemer.  
<p align="center">
  <a href="/img/premium_bot.png">
    <img alt="Premium BOT flowchart" src="media/issuer.png">
  </a>


### Typical Use case
The use case of the Premium BOT is the following:

A user provides an account on the Intrelay parachain (the BOT Interlay Account) with a certain amount of KBTC and some native KINT to pay for gas. Under ideal conditions the amount allocated need not be very large as the KBTC redeemed into BTC are supposed to return to the KBTC walled via the action of the Issuer.  

## Technical details
written in rust
written as an extension of itnerbtc-clients
version for hackathon uses BDK package to generate BTC wallet and transactions.
 
## How to build
Please read the prerequisites provided in the README_interlay.md file about how to build the interbtc-clients repository. Building the Premium BOT repository uses exactly the same process. You only need to select the correct branch.

At the time of release of the project (3/6/2022) the main branch on Testnet and Kintsugi is 1.11.2 
The corresponding Premium BOT branch is premium-bot-1.11.2.

To test the Premium BOT on the Interlay Testnet build the project with 
```
cargo build --release  --features parachain-metadata-testnet
```
To build and run the project on the Kintsugi network build the project with
```
cargo build --release  --features parachain-metadata-kintsugi
```

## Running the Issuer:
```
./target/release/issuer
```

Command options and flags:

**-v, --verbose**

Returns a verbose log

**--vault-account-id <VAULT_ACCOUNT_ID>**

By default the Issuer will select a vault with sufficient capacity. For testing purposes, or in case the Bot is linked to a vault account that is set to accept only its own accounts requests (set to inactive), the user might prefer to explicitely specify the target vault with this option.

**--sleeptime-main-loop <SLEEPTIME_MAIN_LOOP>**

**--sleeptime-no-issuable-vault <SLEEPTIME_NO_ISSUABLE_VAULT>**

**--sleeptime-not-enough-btc <SLEEPTIME_NOT_ENOUGH_BTC>**

By default the Issuer will pause 15 seconds after every loop and after determining that its BTC balance is insufficient or that no eligible vault is available.
The above options allow the user to fine tune these idle times

**--min-btc-balance <MIN_BTC_BALANCE>**

The minimum required  BTC wallet amount in sat for the Issuer to request an issue [default: 2000]

**--max-issue-amount <MIN_ISSUE_AMOUNT>**
The maximum amount in satoshis allowed for an individual issue request generated by the Issuer. The issue request will be max between this value and the greater available vault issuable capacity [default: 2000]

**--min-issue-amount <MIN_ISSUE_AMOUNT>**
The minimum amount in satoshis allowed for the Issuer to generate an issue request, must be greater than Bridge Fee + BTC Network Fee + BTC Dust Limit [default: 2000]

**--wait-for-issued-kbtc**
Issuer will pause after executing the BTC payment to wait for the KBTC to be minted by the vault. A check is done every <SLEEPTIME_MAIN_LOOP> seconds 

**-- keyfile <KEYFILE>**

**-- keyname**

**-- keyfile_btc <KEYFILE_BTC>**

**-- keyname_btc**

The Redeemer and Issuer will read the Kintsugi and BTC account information from 2 json files. keyfile.json and keyfile_btc.json
Unless specified in a commandline option, the binaries look for those files in the current durectory. 
In each file the entry with the correct keyname is read. By default the keynames are "keyname" for feyfile.json and keyname_btc for "keyfile_btc.json". You can override these defaults with a commandline option.

*keyfile.json*

This file should contain the Kintsugi account of the BOT. You should follow the same syntax as the keyfile for vault accounts[^2]. 

*keyfile_btc.json*

This file should contain the extended master private keys to the BTC wallet. 
The BOT has been tested with keys generated on the Wasabi desktop wallet.
To setup a test wallet:
- Run Wasabi
- In settings choose Testnet
- Generate a wallet (write down seed words, and password)

To setup the keyfile_btc.json file
- Load the walled. Then in Advanced select Wallet Info. Enter the wallet password to see the Extended Master Private Key.
- Edit the keyfile_btc.json file as follows[^3] (you can replace keyname_btc, but the default value used by the Issuer is "keyname_btc" )
```
{
  "keyname_btc": ["wpkh(tprv8ZgxMBicQKsPctgasNzABhRCAfReohQPdu235WxXhu7yuh3by91GhqZgRGN6GEdARTEWJ2iURcjtbAub8ifnzbym5vGs4V54DwK8VL9b9oZ/84'/0'/0'/0/*)",
                  "wpkh(tprv8ZgxMBicQKsPctgasNzABhRCAfReohQPdu235WxXhu7yuh3by91GhqZgRGN6GEdARTEWJ2iURcjtbAub8ifnzbym5vGs4V54DwK8VL9b9oZ/84'/0'/0'/1/*)"]
}
```
### Example execution of the Issuer
The below output is run with the default settings so no command option needed to be entered. It is a Interlay Testnet execution as mentionned in the log.
We only added the --wait-for-issued-kbtc option to wait for the change in kBTC balance. This is mainly for testing and demo purposes. In a normal running mode the bot does not need to wait for confirmation.

```
 ~/int/my-interbtc-clients-cli â”‚ premium-bot-1.11.2c !10 ?2  ./target/release/issuer --wait-for-issued-kbtc                   
[2022-05-28T10:47:55Z INFO  issuer] Connected to Testnet parachain
[2022-05-28T10:47:55Z INFO  issuer] -------------------------------
[2022-05-28T10:47:55Z INFO  issuer] Automatic selection of vault
[2022-05-28T10:47:55Z INFO  issuer] Signer:           5GTH76cE3vQyehe5w2Q9si4nxZ1izyvQzB6WezCSJGTKxwCU
[2022-05-28T10:47:55Z INFO  issuer] Max BTC Issue amount:     2000 KBTC sat
[2022-05-28T10:47:55Z INFO  issuer] Min BTC Issue amount:     2000 KBTC sat
[2022-05-28T10:47:55Z INFO  issuer] Min BTC balance:          2000 KBTC sat
[2022-05-28T10:47:56Z INFO  issuer] Initial wrapped balance:  38073 KBTC sat
[2022-05-28T10:47:56Z INFO  issuer] Initial native balance:   733947710109 KINT planck
[2022-05-28T10:47:56Z INFO  issuer] Setting up BTC wallet
[2022-05-28T10:47:59Z INFO  issuer] Initial BTC balance:      7820540 BTC sat
[2022-05-28T10:47:59Z INFO  issuer] [1]-------------------------------
[2022-05-28T10:48:01Z INFO  issuer] Selected vault 5GBfrVtunvfHNo2R35UwSpUciBApSkFCvwpZ6gPznQeDKFC9 with issuable amount of 50437308 KBTC
[2022-05-28T10:48:01Z INFO  issuer] Sending issue request to parachain
[2022-05-28T10:48:44Z INFO  issuer] Issue request accepted
[2022-05-28T10:48:44Z INFO  issuer] Issue BTC address: "tb1qfylc35ne4rrk6f8w2tlzpxhl05uw8uhxky7ws2"
[2022-05-28T10:48:44Z INFO  issuer] Issue amount:     1997 KBTC Sat
[2022-05-28T10:48:44Z INFO  issuer] Issue fee:        3 KBTC Sat
[2022-05-28T10:48:44Z INFO  issuer] Building BTC transaction
[2022-05-28T10:48:44Z INFO  issuer] TXID:  5bf2e571dc4bf2dd7cfad6b64d090321027e34c95cf3ebd116d992e21b19575b
[2022-05-28T10:48:44Z INFO  issuer] Signing BTC transaction
[2022-05-28T10:48:44Z INFO  issuer] Transaction signed & sent - https://blockstream.info/testnet/tx/5bf2e571dc4bf2dd7cfad6b64d090321027e34c95cf3ebd116d992e21b19575b
[2022-05-28T10:48:44Z INFO  issuer] Waiting 15 seconds for BTC tranfer completion
[2022-05-28T10:48:59Z INFO  issuer] Waiting 15 seconds for BTC tranfer completion
...
[2022-05-28T11:00:51Z INFO  issuer] Waiting 15 seconds for BTC tranfer completion
[2022-05-28T11:01:10Z INFO  issuer] KBTC balance:       40070 KBTC sat
[2022-05-28T11:01:10Z INFO  issuer] KINT balance:       732834773290 KINT planck
[2022-05-28T11:01:10Z INFO  issuer] BTC balance:        7818399 BTC sat
[2022-05-28T11:01:10Z INFO  issuer] Delta KBTC balance: 1997 KBTC sat
[2022-05-28T11:01:10Z INFO  issuer] Delta KINT balance: -1112936819 KINT planck
[2022-05-28T11:01:10Z INFO  issuer] Delta BTC balance:  -2141 BTC sat
[2022-05-28T11:01:10Z INFO  issuer] Waiting 15 seconds before next loop iteration
[2022-05-28T11:01:25Z INFO  issuer] [2]-------------------------------
[2022-05-28T11:01:27Z INFO  issuer] Selected vault 5GBfrVtunvfHNo2R35UwSpUciBApSkFCvwpZ6gPznQeDKFC9 with issuable amount of 50474090 KBTC
[2022-05-28T11:01:27Z INFO  issuer] Sending issue request to parachain
[2022-05-28T11:02:07Z INFO  issuer] Issue request accepted
[2022-05-28T11:02:07Z INFO  issuer] Issue BTC address: "tb1q7c7er3xjqcwmdd3wtghca6psdjh2ta4whpehml"
[2022-05-28T11:02:07Z INFO  issuer] Issue amount:     1997 KBTC sat
[2022-05-28T11:02:07Z INFO  issuer] Issue fee:        3 KBTC sat
[2022-05-28T11:02:07Z INFO  issuer] Building BTC transaction
[2022-05-28T11:02:07Z INFO  issuer] TXID:  0543ea64881327dc7be28a1e201d580114496d682397231f9dc831b5e34ec9bc
[2022-05-28T11:02:07Z INFO  issuer] Signing BTC transaction
[2022-05-28T11:02:08Z INFO  issuer] Transaction signed & sent - https://blockstream.info/testnet/tx/0543ea64881327dc7be28a1e201d580114496d682397231f9dc831b5e34ec9bc
[2022-05-28T11:02:08Z INFO  issuer] Not waiting for BTC transfer completion. KBTC balance will be initially unchanged
[2022-05-28T11:02:09Z INFO  issuer] KBTC balance:       44064 KBTC sat
[2022-05-28T11:02:09Z INFO  issuer] KINT balance:       731730606784 KINT planck
[2022-05-28T11:02:09Z INFO  issuer] BTC balance:        7816258 BTC sat
[2022-05-28T11:02:09Z INFO  issuer] Delta KBTC balance: 3994 KBTC sat
[2022-05-28T11:02:09Z INFO  issuer] Delta KINT balance: -1104166506 KINT planck
[2022-05-28T11:02:09Z INFO  issuer] Delta BTC balance:  -2141 BTC sat
[2022-05-28T11:02:09Z INFO  issuer] Waiting 15 seconds before next loop iteration
``` 




[^1]: We refer here to a Kintsugi Parachain, but the Premium BOT will work similarly in a Testnet or Interlay network. Just replace the Kintsugi, KBTC, KINT, KSM terms accordingly.
[^2]: See https://docs.interlay.io/#/vault/installation?id=prerequisites
[^3]: The extended master private key mentionned here is the actual key used on BTC Testnet to test the BOT during development. You can reuse it to confirm the BOT runs correctly. 

